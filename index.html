<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daewoong S&T Inventory System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SheetJS (Excel Processing) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Google Font (Noto Sans KR) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { bg: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-2xl z-20">
        <div class="p-6 border-b border-slate-800 bg-slate-950">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-industry text-blue-500 text-2xl"></i>
                <div>
                    <h1 class="font-bold text-lg tracking-tight">Daewoong S&T</h1>
                    <p class="text-xs text-slate-400">Inventory Management</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchTab('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-dashboard">
                <i class="fa-solid fa-chart-pie w-5"></i> <span class="font-medium">대시보드</span>
            </button>
            <button onclick="switchTab('inventory')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-inventory">
                <i class="fa-solid fa-layer-group w-5"></i> <span class="font-medium">통합 재고 현황</span>
            </button>
            <button onclick="switchTab('rules')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-rules">
                <i class="fa-solid fa-tags w-5"></i> <span class="font-medium">업체별 아이템 리스트</span>
            </button>
            <button onclick="switchTab('upload')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-upload">
                <i class="fa-solid fa-file-excel w-5"></i> <span class="font-medium">엑셀 일괄 등록</span>
            </button>
        </nav>

        <div class="p-4 bg-slate-900 border-t border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold">허</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-bold truncate">허창수 법인장</p>
                    <p class="text-xs text-slate-400 truncate">admin@daewoongvina.com</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Header -->
        <header class="bg-white h-16 border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-slate-600"><i class="fa-solid fa-bars text-xl"></i></button>
                <h2 class="text-xl font-bold text-slate-800" id="page-title">대시보드</h2>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs font-semibold bg-blue-50 text-blue-700 px-3 py-1 rounded-full border border-blue-100">
                    <i class="fa-solid fa-location-dot mr-1"></i> 호치민 법인
                </span>
                <button class="text-slate-400 hover:text-slate-600 transition-colors"><i class="fa-solid fa-gear"></i></button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 overflow-auto p-6 relative">
            
            <!-- 1. Dashboard Section -->
            <div id="view-dashboard" class="space-y-6 fade-in">
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-weight-hanging text-6xl text-blue-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">총 재고 중량</p>
                        <h3 class="text-2xl font-bold text-slate-800" id="dash-total-weight">0 <span class="text-sm font-normal text-slate-500">Ton</span></h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-boxes-stacked text-6xl text-emerald-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">총 재고 수량</p>
                        <h3 class="text-2xl font-bold text-slate-800" id="dash-total-count">0 <span class="text-sm font-normal text-slate-500">EA</span></h3>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-building text-6xl text-indigo-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">관리 업체 수</p>
                        <h3 class="text-2xl font-bold text-slate-800">5 <span class="text-sm font-normal text-slate-500">개사</span></h3>
                    </div>
                </div>

                <!-- Vendor Breakdown -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">업체별 재고 현황</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 uppercase font-semibold">
                                <tr>
                                    <th class="px-6 py-3">업체명 (Vendor)</th>
                                    <th class="px-6 py-3 text-right">보유 수량</th>
                                    <th class="px-6 py-3 text-right">총 중량 (kg)</th>
                                    <th class="px-6 py-3">비고</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="dashboard-vendor-table">
                                <!-- JS will populate this -->
                                <tr><td colspan="4" class="p-4 text-center text-slate-400">데이터 로딩중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. Inventory List Section -->
            <div id="view-inventory" class="hidden h-full flex flex-col fade-in">
                <!-- Filters -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4 flex flex-col md:flex-row gap-4 justify-between items-center">
                    <div class="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0" id="vendor-tabs">
                        <button onclick="filterVendor('ALL')" class="vendor-tab active px-4 py-2 rounded-lg text-sm font-bold transition-colors bg-blue-600 text-white shadow-md shadow-blue-200" data-vendor="ALL">ALL</button>
                        <button onclick="filterVendor('INZI')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="INZI">INZI</button>
                        <button onclick="filterVendor('SHINHEUNG')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="SHINHEUNG">SHINHEUNG</button>
                        <button onclick="filterVendor('DAEYEONG')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="DAEYEONG">DAEYEONG</button>
                        <button onclick="filterVendor('DA')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="DA">DA</button>
                        <button onclick="filterVendor('ETD')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="ETD">ETD</button>
                    </div>
                    <div class="relative w-full md:w-64">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="search-input" onkeyup="renderTable()" placeholder="Spec, 제품명 검색..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-sm text-left relative">
                            <thead class="bg-slate-50 text-slate-600 font-semibold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-6 py-3 whitespace-nowrap">Vendor</th>
                                    <th class="px-6 py-3 whitespace-nowrap">품명 (Product)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">강종 (Spec)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">두께 (T)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">폭 (W)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">길이 (L)</th>
                                    <th class="px-6 py-3 text-right whitespace-nowrap">중량 (kg)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">창고 (위치)</th>
                                    <th class="px-6 py-3 text-center whitespace-nowrap">관리</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="inventory-table-body">
                                <!-- Data goes here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-200 bg-slate-50 text-right text-xs text-slate-500">
                        총 검색된 항목: <span id="table-count" class="font-bold text-slate-700">0</span> 건
                    </div>
                </div>
            </div>

            <!-- 3. Vendor Item List (Rules) Section -->
            <div id="view-rules" class="hidden fade-in max-w-6xl mx-auto h-full flex flex-col">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-2">업체별 자동 분류 기준 (System Rules)</h3>
                    <p class="text-sm text-slate-500 mb-4">엑셀 업로드 시 아래 조건에 따라 자동으로 업체가 배정됩니다.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Rule Cards -->
                        <div class="p-4 rounded-lg border border-l-4 border-slate-200 border-l-blue-500 bg-blue-50/50">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-blue-900">INZI</h4>
                                <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded font-bold">Rule 1</span>
                            </div>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>• 품명에 <strong>'SPHC'</strong> 포함</li>
                                <li>• 또는 두께(T)가 <strong>2.0mm 이상</strong></li>
                            </ul>
                        </div>

                        <div class="p-4 rounded-lg border border-l-4 border-slate-200 border-l-orange-500 bg-orange-50/50">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-orange-900">SHINHEUNG</h4>
                                <span class="bg-orange-100 text-orange-700 text-xs px-2 py-0.5 rounded font-bold">Rule 2</span>
                            </div>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>• 품명 또는 강종에 <strong>'GI'</strong> 포함</li>
                            </ul>
                        </div>

                        <div class="p-4 rounded-lg border border-l-4 border-slate-200 border-l-emerald-500 bg-emerald-50/50">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-emerald-900">DAEYEONG</h4>
                                <span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-0.5 rounded font-bold">Rule 3</span>
                            </div>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>• 품명 또는 강종에 <strong>'CR'</strong> 포함</li>
                            </ul>
                        </div>

                        <div class="p-4 rounded-lg border border-l-4 border-slate-200 border-l-purple-500 bg-purple-50/50">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-purple-900">DA</h4>
                                <span class="bg-purple-100 text-purple-700 text-xs px-2 py-0.5 rounded font-bold">Rule 4</span>
                            </div>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>• 품명 또는 강종에 <strong>'PO'</strong> 포함</li>
                            </ul>
                        </div>

                        <div class="p-4 rounded-lg border border-l-4 border-slate-200 border-l-slate-500 bg-slate-50">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-slate-900">ETD</h4>
                                <span class="bg-slate-200 text-slate-700 text-xs px-2 py-0.5 rounded font-bold">Default</span>
                            </div>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>• 위 조건에 해당하지 않는 모든 자재</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Classified Items Summary -->
                <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 p-6 overflow-hidden flex flex-col">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">현재 분류된 아이템 리스트 (Summary)</h3>
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-semibold sticky top-0">
                                <tr>
                                    <th class="px-6 py-3">업체명</th>
                                    <th class="px-6 py-3">주요 품목/강종</th>
                                    <th class="px-6 py-3 text-right">등록된 수량</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="rules-summary-table">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. Upload Section -->
            <div id="view-upload" class="hidden fade-in max-w-3xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200 bg-slate-50">
                        <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-file-import text-blue-600"></i> 엑셀 재고 등록
                        </h3>
                        <p class="text-sm text-slate-500 mt-2">
                            회사 양식(01JAN2025.xlsx)을 업로드하면 시스템이 <strong>헤더를 자동 인식</strong>하여 등록합니다.
                        </p>
                    </div>
                    
                    <div class="p-8 space-y-8">
                        <div class="flex items-start gap-4">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold flex-shrink-0">1</div>
                            <div class="flex-1 w-full">
                                <h4 class="font-bold text-slate-700 mb-2">파일 업로드 및 자동 분류</h4>
                                <div class="w-full border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer relative" id="drop-zone">
                                    <input type="file" id="excel-input" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3" id="upload-icon"></i>
                                    <p class="font-medium text-slate-600" id="upload-text">엑셀 파일을 이곳에 드래그하거나 클릭하세요</p>
                                    <p class="text-xs text-slate-400 mt-1">.xlsx 또는 .xls 파일만 가능</p>
                                </div>
                            </div>
                        </div>

                        <!-- Processing Log -->
                        <div id="upload-log" class="hidden bg-slate-50 p-4 rounded-lg border border-slate-200 font-mono text-xs text-slate-600 max-h-40 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        window.db = null;
        window.auth = null;
        window.appId = 'daewoong-st-inventory-v1'; 
        window.userId = null;
        window.inventoryData = [];
        let unsubscribe = null;

        // [IMPORTANT] Replace with your actual Firebase Config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        async function initFirebase() {
            try {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Firebase Config가 설정되지 않았습니다.");
                }

                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                
                await signInAnonymously(window.auth);

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        loadInventory(); 
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('inventory-table-body').innerHTML = '<tr><td colspan="9" class="p-8 text-center text-red-500">데이터베이스 연결 실패<br><span class="text-xs text-slate-400">index.html 파일을 열어 firebaseConfig 값을 설정해주세요.</span></td></tr>';
            }
        }

        function loadInventory() {
            if (!window.db || !window.userId) return;

            const q = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory');
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                window.inventoryData = [];
                snapshot.forEach((doc) => {
                    window.inventoryData.push({ id: doc.id, ...doc.data() });
                });
                
                window.inventoryData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                updateDashboard();
                updateRulesSummary();
                renderTable(); 
            }, (error) => {
                console.error("Data fetch error:", error);
            });
        }

        // --- UI Functions ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');

            const titles = {
                'dashboard': '대시보드',
                'inventory': '통합 재고 현황',
                'rules': '업체별 아이템 리스트',
                'upload': '엑셀 일괄 등록'
            };
            document.getElementById('page-title').innerText = titles[tabName];

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                el.classList.add('text-slate-400');
            });
            const activeNav = document.getElementById(`nav-${tabName}`);
            activeNav.classList.remove('text-slate-400');
            activeNav.classList.add('bg-blue-600', 'text-white', 'shadow-lg');

            if(tabName === 'inventory') renderTable();
            if(tabName === 'rules') updateRulesSummary();
        }

        window.currentVendorFilter = 'ALL';

        window.filterVendor = function(vendor) {
            window.currentVendorFilter = vendor;
            document.querySelectorAll('.vendor-tab').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'active');
                btn.classList.add('text-slate-600', 'hover:bg-slate-100');
                if(btn.dataset.vendor === vendor) {
                    btn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'active');
                }
            });
            renderTable();
        }

        window.renderTable = function() {
            const tbody = document.getElementById('inventory-table-body');
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = window.inventoryData.filter(item => {
                if (window.currentVendorFilter !== 'ALL' && item.vendor !== window.currentVendorFilter) return false;
                const searchStr = `${item.product} ${item.spec} ${item.location}`.toLowerCase();
                if (searchInput && !searchStr.includes(searchInput)) return false;
                return true;
            });

            document.getElementById('table-count').innerText = filtered.length;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-slate-400">데이터가 없습니다.</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(item => `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50">
                    <td class="px-6 py-3 font-bold text-xs">
                        <span class="px-2 py-1 rounded bg-slate-100 text-slate-600 border border-slate-200">${item.vendor}</span>
                    </td>
                    <td class="px-6 py-3 font-medium text-slate-800">${item.product || '-'}</td>
                    <td class="px-6 py-3 text-slate-600">${item.spec || '-'}</td>
                    <td class="px-6 py-3 text-slate-600">${item.thickness || 0}</td>
                    <td class="px-6 py-3 text-slate-600">${item.width || 0}</td>
                    <td class="px-6 py-3 text-slate-600">${item.length || 0}</td>
                    <td class="px-6 py-3 text-right font-mono font-bold text-slate-700">${Number(item.weight).toLocaleString()}</td>
                    <td class="px-6 py-3 text-center text-xs text-slate-500 bg-slate-50 rounded mx-2">${item.location || '미지정'}</td>
                    <td class="px-6 py-3 text-center">
                        <button onclick="deleteItem('${item.id}')" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        window.updateRulesSummary = function() {
            const vendors = ['INZI', 'SHINHEUNG', 'DAEYEONG', 'DA', 'ETD'];
            const summaryBody = document.getElementById('rules-summary-table');
            
            // Analyze existing data
            const stats = {};
            vendors.forEach(v => stats[v] = { count: 0, specs: new Set() });
            
            window.inventoryData.forEach(item => {
                const v = item.vendor && vendors.includes(item.vendor) ? item.vendor : 'ETD';
                if(stats[v]) {
                    stats[v].count++;
                    if(item.spec) stats[v].specs.add(item.spec);
                }
            });

            summaryBody.innerHTML = vendors.map(v => {
                const specList = Array.from(stats[v].specs).slice(0, 3).join(', ') + (stats[v].specs.size > 3 ? '...' : '');
                return `
                <tr class="border-b border-slate-50">
                    <td class="px-6 py-4 font-bold text-slate-700">${v}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs">${specList || '-'}</td>
                    <td class="px-6 py-4 text-right font-mono">${stats[v].count.toLocaleString()}</td>
                </tr>`;
            }).join('');
        }

        window.deleteItem = async function(id) {
            if(confirm('정말 삭제하시겠습니까?')) {
                try {
                    await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', id));
                } catch(e) {
                    alert('삭제 중 오류 발생: ' + e.message);
                }
            }
        }

        function updateDashboard() {
            const totalW = window.inventoryData.reduce((acc, curr) => acc + (Number(curr.weight) || 0), 0);
            const totalC = window.inventoryData.length;

            document.getElementById('dash-total-weight').innerHTML = `${(totalW/1000).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})} <span class="text-sm font-normal text-slate-500">Ton</span>`;
            document.getElementById('dash-total-count').innerHTML = `${totalC.toLocaleString()} <span class="text-sm font-normal text-slate-500">EA</span>`;

            const vendors = ['INZI', 'SHINHEUNG', 'DAEYEONG', 'DA', 'ETD'];
            const stats = {};
            vendors.forEach(v => stats[v] = { count: 0, weight: 0 });
            
            window.inventoryData.forEach(item => {
                const v = item.vendor && vendors.includes(item.vendor) ? item.vendor : 'ETD';
                if (!stats[v]) stats[v] = { count: 0, weight: 0 };
                stats[v].count++;
                stats[v].weight += (Number(item.weight) || 0);
            });

            const vendorTableHTML = vendors.map(v => `
                <tr class="hover:bg-slate-50 border-b border-slate-50">
                    <td class="px-6 py-4 font-bold text-slate-700">${v}</td>
                    <td class="px-6 py-4 text-right">${stats[v].count.toLocaleString()} EA</td>
                    <td class="px-6 py-4 text-right font-mono">${stats[v].weight.toLocaleString()} kg</td>
                    <td class="px-6 py-4">
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${totalW > 0 ? (stats[v].weight / totalW * 100) : 0}%"></div>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('dashboard-vendor-table').innerHTML = vendorTableHTML;
        }

        // --- Logic: Determine Vendor ---
        function determineVendor(row) {
            // Rule Logic based on User Request
            const product = (row.product || '').toUpperCase();
            const spec = (row.spec || '').toUpperCase();
            const thickness = Number(row.thickness) || 0;
            
            // 1. INZI: SPHC or T >= 2.0
            if (product.includes('SPHC') || thickness >= 2.0) return 'INZI';
            // 2. SHINHEUNG: GI
            if (product.includes('GI') || spec.includes('GI')) return 'SHINHEUNG';
            // 3. DAEYEONG: CR
            if (product.includes('CR') || spec.includes('CR')) return 'DAEYEONG';
            // 4. DA: PO
            if (product.includes('PO') || spec.includes('PO')) return 'DA';
            
            return 'ETD';
        }

        window.handleFileSelect = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('upload-text').innerText = `처리중: ${file.name}`;
            document.getElementById('upload-icon').className = "fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-3";
            const logEl = document.getElementById('upload-log');
            logEl.classList.remove('hidden');
            logEl.innerHTML = "<div>파일 읽는 중...</div>";

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON (Header is typically row 2 based on provided file snippet "NO, 일자, ...")
                    // We try to find the header row by looking for "품명" or "제품번호"
                    const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    let headerRowIndex = -1;
                    for(let i=0; i<rawData.length; i++) {
                        const rowStr = rawData[i].join(',').toUpperCase();
                        if(rowStr.includes('품명') && rowStr.includes('두께')) {
                            headerRowIndex = i;
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        throw new Error("헤더를 찾을 수 없습니다. (필수 컬럼: 품명, 두께 T 등)");
                    }

                    logEl.innerHTML += `<div>헤더 발견: ${headerRowIndex + 1}행</div>`;

                    // Create structured JSON
                    const headers = rawData[headerRowIndex];
                    const rows = rawData.slice(headerRowIndex + 1);
                    const batchSize = 500; 
                    let batch = writeBatch(window.db);
                    let count = 0;
                    let ops = 0;

                    // Helper to find column index by keyword
                    const getIdx = (keywords) => headers.findIndex(h => keywords.some(k => (h||'').toString().includes(k)));

                    const idxProduct = getIdx(['품명']);
                    const idxSpec = getIdx(['강종']);
                    const idxThick = getIdx(['두께']);
                    const idxWidth = getIdx(['폭']);
                    const idxLength = getIdx(['길이']);
                    const idxWeight = getIdx(['중량']);
                    const idxLocation = getIdx(['창고', '위치']);

                    for(let row of rows) {
                        if(!row[idxProduct] && !row[idxSpec]) continue; // Skip empty rows

                        const item = {
                            product: row[idxProduct] || '',
                            spec: row[idxSpec] || '',
                            thickness: row[idxThick] || 0,
                            width: row[idxWidth] || 0,
                            length: row[idxLength] || 0,
                            weight: row[idxWeight] || 0,
                            location: row[idxLocation] || '',
                            createdAt: new Date().toISOString()
                        };

                        item.vendor = determineVendor(item);
                        
                        const docRef = doc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory'));
                        batch.set(docRef, item);
                        count++;
                        ops++;

                        if (ops >= batchSize) {
                            await batch.commit();
                            batch = writeBatch(window.db);
                            ops = 0;
                            logEl.innerHTML += `<div>${count}건 처리 중...</div>`;
                        }
                    }

                    if (ops > 0) await batch.commit();
                    
                    logEl.innerHTML += `<div class="text-green-600 font-bold">완료: 총 ${count}건 등록됨</div>`;
                    alert(`${count}건의 재고가 성공적으로 등록되었습니다.`);
                    
                    setTimeout(() => {
                         document.getElementById('upload-text').innerText = "엑셀 파일을 이곳에 드래그하거나 클릭하세요";
                         document.getElementById('upload-icon').className = "fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3";
                         document.getElementById('excel-input').value = "";
                         switchTab('inventory');
                    }, 1000);

                } catch (err) {
                    console.error(err);
                    logEl.innerHTML += `<div class="text-red-500">오류: ${err.message}</div>`;
                    alert("파일 처리 중 오류가 발생했습니다.");
                    document.getElementById('upload-text').innerText = "엑셀 파일을 이곳에 드래그하거나 클릭하세요";
                    document.getElementById('upload-icon').className = "fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        window.onload = function() {
            initFirebase();
            switchTab('dashboard');
        }
    </script>
</body>
</html>