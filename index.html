<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daewoong S&T Inventory System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SheetJS (Excel Processing) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Google Font (Noto Sans KR) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { bg: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-2xl z-20">
        <div class="p-6 border-b border-slate-800 bg-slate-950">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-industry text-blue-500 text-2xl"></i>
                <div>
                    <h1 class="font-bold text-lg tracking-tight">Daewoong S&T</h1>
                    <p class="text-xs text-slate-400">Inventory Management</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchTab('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-dashboard">
                <i class="fa-solid fa-chart-pie w-5"></i> <span class="font-medium">대시보드</span>
            </button>
            <button onclick="switchTab('inventory')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-inventory">
                <i class="fa-solid fa-layer-group w-5"></i> <span class="font-medium">통합 재고 현황</span>
            </button>
            <button onclick="switchTab('master')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-master">
                <i class="fa-solid fa-list-check w-5"></i> <span class="font-medium">업체별 아이템 리스트</span>
            </button>
            <button onclick="switchTab('upload')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-upload">
                <i class="fa-solid fa-file-excel w-5"></i> <span class="font-medium">엑셀 일괄 등록</span>
            </button>
        </nav>

        <div class="p-4 bg-slate-900 border-t border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold">허</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-bold truncate">허창수 법인장</p>
                    <p class="text-xs text-slate-400 truncate">admin@daewoongvina.com</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Header -->
        <header class="bg-white h-16 border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-slate-600"><i class="fa-solid fa-bars text-xl"></i></button>
                <h2 class="text-xl font-bold text-slate-800" id="page-title">대시보드</h2>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs font-semibold bg-blue-50 text-blue-700 px-3 py-1 rounded-full border border-blue-100">
                    <i class="fa-solid fa-location-dot mr-1"></i> 호치민 법인
                </span>
                <button class="text-slate-400 hover:text-slate-600 transition-colors"><i class="fa-solid fa-gear"></i></button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 overflow-auto p-6 relative">
            
            <!-- 1. Dashboard Section -->
            <div id="view-dashboard" class="space-y-6 fade-in">
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-weight-hanging text-6xl text-blue-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">총 재고 중량</p>
                        <h3 class="text-2xl font-bold text-slate-800" id="dash-total-weight">0 <span class="text-sm font-normal text-slate-500">Ton</span></h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-boxes-stacked text-6xl text-emerald-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">총 재고 수량</p>
                        <h3 class="text-2xl font-bold text-slate-800" id="dash-total-count">0 <span class="text-sm font-normal text-slate-500">EA</span></h3>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-building text-6xl text-indigo-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">관리 업체 수</p>
                        <h3 class="text-2xl font-bold text-slate-800">5 <span class="text-sm font-normal text-slate-500">개사</span></h3>
                    </div>
                </div>

                <!-- Vendor Breakdown -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">업체별 재고 현황</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 uppercase font-semibold">
                                <tr>
                                    <th class="px-6 py-3">업체명 (Vendor)</th>
                                    <th class="px-6 py-3 text-right">보유 수량</th>
                                    <th class="px-6 py-3 text-right">총 중량 (kg)</th>
                                    <th class="px-6 py-3">비고</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="dashboard-vendor-table">
                                <!-- JS will populate this -->
                                <tr><td colspan="4" class="p-4 text-center text-slate-400">데이터 로딩중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. Inventory List Section -->
            <div id="view-inventory" class="hidden h-full flex flex-col fade-in">
                <!-- Filters -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4 flex flex-col md:flex-row gap-4 justify-between items-center">
                    <div class="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0" id="vendor-tabs">
                        <button onclick="filterVendor('ALL')" class="vendor-tab active px-4 py-2 rounded-lg text-sm font-bold transition-colors bg-blue-600 text-white shadow-md shadow-blue-200" data-vendor="ALL">ALL</button>
                        <button onclick="filterVendor('INZI')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="INZI">INZI</button>
                        <button onclick="filterVendor('SHINHEUNG')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="SHINHEUNG">SHINHEUNG</button>
                        <button onclick="filterVendor('DAEYEONG')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="DAEYEONG">DAEYEONG</button>
                        <button onclick="filterVendor('DA')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="DA">DA</button>
                        <button onclick="filterVendor('ETD')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="ETD">ETD</button>
                    </div>
                    <div class="relative w-full md:w-64">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="search-input" onkeyup="renderTable()" placeholder="Spec, 제품명 검색..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-sm text-left relative">
                            <thead class="bg-slate-50 text-slate-600 font-semibold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-6 py-3 whitespace-nowrap">Vendor</th>
                                    <th class="px-6 py-3 whitespace-nowrap">CODE</th>
                                    <th class="px-6 py-3 whitespace-nowrap">품명 (Product)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">강종 (Spec)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">두께 (T)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">폭 (W)</th>
                                    <th class="px-6 py-3 text-right whitespace-nowrap">중량 (kg)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">창고 (위치)</th>
                                    <th class="px-6 py-3 text-center whitespace-nowrap">관리</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="inventory-table-body">
                                <!-- Data goes here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-200 bg-slate-50 text-right text-xs text-slate-500">
                        총 검색된 항목: <span id="table-count" class="font-bold text-slate-700">0</span> 건
                    </div>
                </div>
            </div>

            <!-- 3. Master Item List (Rules) Section -->
            <div id="view-master" class="hidden fade-in max-w-6xl mx-auto h-full flex flex-col">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800 mb-1">업체별 아이템 리스트 (Master Data)</h3>
                            <p class="text-sm text-slate-500">
                                엑셀 업로드 시 <strong>CODE</strong>를 기준으로 우선 분류하며, 등록되지 않은 코드는 Spec/두께 등 보조 규칙을 따릅니다.
                            </p>
                        </div>
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="master-search" onkeyup="renderMasterTable()" placeholder="Code, 업체명 검색" class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div class="flex-1 overflow-auto border rounded-lg border-slate-200">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-600 font-semibold sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 w-32">CODE</th>
                                    <th class="px-6 py-3 w-32">Vendor</th>
                                    <th class="px-6 py-3">강종/품목 (Reference)</th>
                                    <th class="px-6 py-3 text-right">분류 우선순위</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="master-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-100 text-xs text-blue-800">
                        <i class="fa-solid fa-circle-info mr-2"></i>
                        현재 시스템에는 <strong>분석된 주요 아이템 리스트</strong>가 탑재되어 있습니다. 리스트에 없는 신규 자재는 엑셀 업로드 시 강종/두께 로직에 의해 자동 분류됩니다.
                    </div>
                </div>
            </div>

            <!-- 4. Upload Section -->
            <div id="view-upload" class="hidden fade-in max-w-3xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200 bg-slate-50">
                        <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-file-import text-blue-600"></i> 엑셀 재고 등록
                        </h3>
                        <p class="text-sm text-slate-500 mt-2">
                            회사 양식(01JAN2025 등)을 업로드하면 <strong>CODE를 우선 분석</strong>하여 업체를 분류합니다.
                        </p>
                    </div>
                    
                    <div class="p-8 space-y-8">
                        <div class="flex items-start gap-4">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold flex-shrink-0">1</div>
                            <div class="flex-1 w-full">
                                <h4 class="font-bold text-slate-700 mb-2">파일 업로드 및 고속 처리</h4>
                                <div class="w-full border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer relative" id="drop-zone">
                                    <input type="file" id="excel-input" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3" id="upload-icon"></i>
                                    <p class="font-medium text-slate-600" id="upload-text">엑셀 파일을 이곳에 드래그하거나 클릭하세요</p>
                                    <p class="text-xs text-slate-400 mt-1">.xlsx 또는 .xls 파일만 가능</p>
                                </div>
                            </div>
                        </div>

                        <!-- Processing Log -->
                        <div id="upload-log" class="hidden bg-slate-50 p-4 rounded-lg border border-slate-200 font-mono text-xs text-slate-600 max-h-40 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        window.db = null;
        window.auth = null;
        window.appId = 'daewoong-st-inventory-v1'; 
        window.userId = null;
        window.inventoryData = [];
        let unsubscribe = null;

        // --- MASTER DATA (Extracted from provided files) ---
        // This is the "Item List" managed by the system
        const MASTER_ITEM_LIST = [
            // INZI (IZ)
            { code: "BN01-01152A", vendor: "INZI", desc: "EGI 0.45" },
            { code: "BN01-00971A", vendor: "INZI", desc: "EGI 0.50" },
            { code: "BN01-01153A", vendor: "INZI", desc: "EGI 0.50" },
            { code: "BN01-00973A", vendor: "INZI", desc: "EGI 0.60" },
            { code: "IZ01-000304", vendor: "INZI", desc: "EGI 0.80" },
            { code: "BN01-00965A", vendor: "INZI", desc: "EGI 0.80" },
            { code: "BN01-00966A", vendor: "INZI", desc: "EGI 0.80" },
            { code: "IZ01-000305", vendor: "INZI", desc: "EGI 0.80" },
            { code: "BN01-01126A", vendor: "INZI", desc: "EGI 1.0" },
            { code: "BN01-00968A", vendor: "INZI", desc: "EGI 1.0" },
            { code: "IZ01-000369", vendor: "INZI", desc: "COLOR/SATIN BLACK 0.6" },
            { code: "IZ01-000435", vendor: "INZI", desc: "COLOR/SATIN BLACK 0.6" },

            // SHINHEUNG (SH)
            { code: "BN01-000420", vendor: "SHINHEUNG", desc: "EGI 0.45" },
            { code: "BN01-000426", vendor: "SHINHEUNG", desc: "EGI 0.5" },
            { code: "BN01-000429", vendor: "SHINHEUNG", desc: "EGI 0.5" },
            { code: "BN01-000432", vendor: "SHINHEUNG", desc: "EGI 0.5" },
            { code: "BN01-000141", vendor: "SHINHEUNG", desc: "EGI 0.5" },
            { code: "BN01-000340", vendor: "SHINHEUNG", desc: "EGI 0.6" },
            { code: "BN01-000437", vendor: "SHINHEUNG", desc: "EGI 1.0" },
            { code: "BN01-000281", vendor: "SHINHEUNG", desc: "EGI 1.0" },
            { code: "BN01-000320", vendor: "SHINHEUNG", desc: "EGI 1.0" },
            { code: "BN01-000128", vendor: "SHINHEUNG", desc: "EGI 0.8" },
            { code: "BN01-000416", vendor: "SHINHEUNG", desc: "EGI 1.0" },
            { code: "BN01-000130", vendor: "SHINHEUNG", desc: "EGI 1.0" },

            // DAEYEONG (DAEYEONG)
            { code: "BN01-00969A", vendor: "DAEYEONG", desc: "EGI 0.45" },
            { code: "BN01-00715A", vendor: "DAEYEONG", desc: "EGI 0.5" },
            { code: "BN01-00963A", vendor: "DAEYEONG", desc: "EGI 0.5" },
            { code: "BN01-00964A", vendor: "DAEYEONG", desc: "EGI 0.5" },
            { code: "BN01-01118A", vendor: "DAEYEONG", desc: "EGI 0.5" },
            { code: "BN01-00970A", vendor: "DAEYEONG", desc: "EGI 0.5" },
            
            // Common/Shared (Logic will default to one, or use as fallback)
            { code: "AA13T2335", vendor: "ETD", desc: "ALCOSTA" }, // Assuming ETD for general
        ];

        // [IMPORTANT] Replace with your actual Firebase Config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        async function initFirebase() {
            try {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Firebase Config가 설정되지 않았습니다.");
                }

                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                
                await signInAnonymously(window.auth);

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        loadInventory(); 
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('inventory-table-body').innerHTML = '<tr><td colspan="9" class="p-8 text-center text-red-500">데이터베이스 연결 실패<br><span class="text-xs text-slate-400">index.html 파일을 열어 firebaseConfig 값을 설정해주세요.</span></td></tr>';
            }
        }

        function loadInventory() {
            if (!window.db || !window.userId) return;

            const q = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory');
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                window.inventoryData = [];
                snapshot.forEach((doc) => {
                    window.inventoryData.push({ id: doc.id, ...doc.data() });
                });
                
                window.inventoryData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                updateDashboard();
                renderTable(); 
            }, (error) => {
                console.error("Data fetch error:", error);
            });
        }

        // --- UI Functions ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');

            const titles = {
                'dashboard': '대시보드',
                'inventory': '통합 재고 현황',
                'master': '업체별 아이템 리스트',
                'upload': '엑셀 일괄 등록'
            };
            document.getElementById('page-title').innerText = titles[tabName];

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                el.classList.add('text-slate-400');
            });
            const activeNav = document.getElementById(`nav-${tabName}`);
            activeNav.classList.remove('text-slate-400');
            activeNav.classList.add('bg-blue-600', 'text-white', 'shadow-lg');

            if(tabName === 'inventory') renderTable();
            if(tabName === 'master') renderMasterTable();
        }

        window.currentVendorFilter = 'ALL';

        window.filterVendor = function(vendor) {
            window.currentVendorFilter = vendor;
            document.querySelectorAll('.vendor-tab').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'active');
                btn.classList.add('text-slate-600', 'hover:bg-slate-100');
                if(btn.dataset.vendor === vendor) {
                    btn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'active');
                }
            });
            renderTable();
        }

        window.renderTable = function() {
            const tbody = document.getElementById('inventory-table-body');
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = window.inventoryData.filter(item => {
                if (window.currentVendorFilter !== 'ALL' && item.vendor !== window.currentVendorFilter) return false;
                const searchStr = `${item.code} ${item.product} ${item.spec} ${item.location}`.toLowerCase();
                if (searchInput && !searchStr.includes(searchInput)) return false;
                return true;
            });

            document.getElementById('table-count').innerText = filtered.length;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-slate-400">데이터가 없습니다.</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(item => `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50">
                    <td class="px-6 py-3 font-bold text-xs">
                        <span class="px-2 py-1 rounded bg-slate-100 text-slate-600 border border-slate-200">${item.vendor}</span>
                    </td>
                    <td class="px-6 py-3 text-slate-600 text-xs font-mono">${item.code || '-'}</td>
                    <td class="px-6 py-3 font-medium text-slate-800">${item.product || '-'}</td>
                    <td class="px-6 py-3 text-slate-600">${item.spec || '-'}</td>
                    <td class="px-6 py-3 text-slate-600">${item.thickness || 0}</td>
                    <td class="px-6 py-3 text-slate-600">${item.width || 0}</td>
                    <td class="px-6 py-3 text-right font-mono font-bold text-slate-700">${Number(item.weight).toLocaleString()}</td>
                    <td class="px-6 py-3 text-center text-xs text-slate-500 bg-slate-50 rounded mx-2">${item.location || '미지정'}</td>
                    <td class="px-6 py-3 text-center">
                        <button onclick="deleteItem('${item.id}')" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        window.renderMasterTable = function() {
            const tbody = document.getElementById('master-table-body');
            const searchInput = document.getElementById('master-search').value.toLowerCase();
            
            const filtered = MASTER_ITEM_LIST.filter(item => 
                item.code.toLowerCase().includes(searchInput) || 
                item.vendor.toLowerCase().includes(searchInput)
            );

            tbody.innerHTML = filtered.map(item => `
                <tr class="hover:bg-slate-50 border-b border-slate-50">
                    <td class="px-6 py-3 font-mono font-bold text-blue-600">${item.code}</td>
                    <td class="px-6 py-3 font-bold text-slate-700">${item.vendor}</td>
                    <td class="px-6 py-3 text-slate-600">${item.desc}</td>
                    <td class="px-6 py-3 text-right text-xs text-slate-400">High (Code Match)</td>
                </tr>
            `).join('');
        }

        window.deleteItem = async function(id) {
            if(confirm('정말 삭제하시겠습니까?')) {
                try {
                    await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', id));
                } catch(e) {
                    alert('삭제 중 오류 발생: ' + e.message);
                }
            }
        }

        function updateDashboard() {
            const totalW = window.inventoryData.reduce((acc, curr) => acc + (Number(curr.weight) || 0), 0);
            const totalC = window.inventoryData.length;

            document.getElementById('dash-total-weight').innerHTML = `${(totalW/1000).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})} <span class="text-sm font-normal text-slate-500">Ton</span>`;
            document.getElementById('dash-total-count').innerHTML = `${totalC.toLocaleString()} <span class="text-sm font-normal text-slate-500">EA</span>`;

            const vendors = ['INZI', 'SHINHEUNG', 'DAEYEONG', 'DA', 'ETD'];
            const stats = {};
            vendors.forEach(v => stats[v] = { count: 0, weight: 0 });
            
            window.inventoryData.forEach(item => {
                const v = item.vendor && vendors.includes(item.vendor) ? item.vendor : 'ETD';
                if (!stats[v]) stats[v] = { count: 0, weight: 0 };
                stats[v].count++;
                stats[v].weight += (Number(item.weight) || 0);
            });

            const vendorTableHTML = vendors.map(v => `
                <tr class="hover:bg-slate-50 border-b border-slate-50">
                    <td class="px-6 py-4 font-bold text-slate-700">${v}</td>
                    <td class="px-6 py-4 text-right">${stats[v].count.toLocaleString()} EA</td>
                    <td class="px-6 py-4 text-right font-mono">${stats[v].weight.toLocaleString()} kg</td>
                    <td class="px-6 py-4">
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${totalW > 0 ? (stats[v].weight / totalW * 100) : 0}%"></div>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('dashboard-vendor-table').innerHTML = vendorTableHTML;
        }

        // --- Logic: Determine Vendor (Enhanced) ---
        function determineVendor(row) {
            const code = (row.code || '').trim().toUpperCase();
            
            // 1. Check Master List (Exact Code Match)
            const masterMatch = MASTER_ITEM_LIST.find(m => m.code === code);
            if (masterMatch) {
                return masterMatch.vendor;
            }

            // 2. Fallback Logic (Heuristics based on Spec/Thick/Product)
            const product = (row.product || '').toUpperCase();
            const spec = (row.spec || '').toUpperCase();
            const thickness = Number(row.thickness) || 0;
            
            // INZI
            if (product.includes('SPHC') || thickness >= 2.0) return 'INZI';
            
            // SHINHEUNG
            if (product.includes('GI') || spec.includes('GI')) return 'SHINHEUNG';
            
            // DAEYEONG
            if (product.includes('CR') || spec.includes('CR')) return 'DAEYEONG';
            
            // DA
            if (product.includes('PO') || spec.includes('PO')) return 'DA';
            
            return 'ETD';
        }

        window.handleFileSelect = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('upload-text').innerText = `처리중: ${file.name}`;
            document.getElementById('upload-icon').className = "fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-3";
            const logEl = document.getElementById('upload-log');
            logEl.classList.remove('hidden');
            logEl.innerHTML = "<div>파일 읽는 중...</div>";

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    let headerRowIndex = -1;
                    for(let i=0; i<rawData.length; i++) {
                        const rowStr = rawData[i].join(',').toUpperCase();
                        if(rowStr.includes('품명') && rowStr.includes('두께')) {
                            headerRowIndex = i;
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        throw new Error("헤더를 찾을 수 없습니다. (필수 컬럼: 품명, 두께 T, CODE/제품번호 등)");
                    }

                    logEl.innerHTML += `<div>헤더 발견: ${headerRowIndex + 1}행</div>`;

                    const headers = rawData[headerRowIndex];
                    const rows = rawData.slice(headerRowIndex + 1);
                    const batchSize = 500; 
                    
                    const getIdx = (keywords) => headers.findIndex(h => keywords.some(k => (h||'').toString().toUpperCase().includes(k)));

                    const idxProduct = getIdx(['품명']);
                    const idxCode = getIdx(['제품번호', 'CODE', 'ERP']); // Added Code Search
                    const idxSpec = getIdx(['강종']);
                    const idxThick = getIdx(['두께']);
                    const idxWidth = getIdx(['폭']);
                    const idxLength = getIdx(['길이']);
                    const idxWeight = getIdx(['중량']);
                    const idxLocation = getIdx(['창고', '위치']);

                    // 1. Prepare data in memory
                    const preparedItems = [];
                    for(let row of rows) {
                        if(!row[idxProduct] && !row[idxSpec]) continue;

                        const item = {
                            code: idxCode > -1 ? (row[idxCode] || '') : '',
                            product: row[idxProduct] || '',
                            spec: row[idxSpec] || '',
                            thickness: row[idxThick] || 0,
                            width: row[idxWidth] || 0,
                            length: row[idxLength] || 0,
                            weight: row[idxWeight] || 0,
                            location: row[idxLocation] || '',
                            createdAt: new Date().toISOString()
                        };

                        item.vendor = determineVendor(item);
                        preparedItems.push(item);
                    }

                    // 2. Parallel Batch Processing
                    const totalItems = preparedItems.length;
                    const parallelLimit = 10;
                    const chunkSize = batchSize * parallelLimit;
                    
                    logEl.innerHTML += `<div>총 ${totalItems}건 데이터 준비 완료. 고속 업로드 시작...</div>`;

                    for (let i = 0; i < totalItems; i += chunkSize) {
                        const promises = [];
                        
                        for (let j = 0; j < parallelLimit; j++) {
                            const start = i + (j * batchSize);
                            const end = Math.min(start + batchSize, totalItems);
                            
                            if (start >= totalItems) break;

                            const batch = writeBatch(window.db);
                            const chunk = preparedItems.slice(start, end);
                            
                            chunk.forEach(item => {
                                const docRef = doc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory'));
                                batch.set(docRef, item);
                            });

                            promises.push(batch.commit());
                        }

                        await Promise.all(promises);
                        
                        const processed = Math.min(i + chunkSize, totalItems);
                        const pTag = document.createElement('div');
                        pTag.textContent = `${processed} / ${totalItems} 처리 완료...`;
                        logEl.appendChild(pTag);
                        logEl.scrollTop = logEl.scrollHeight;
                    }
                    
                    logEl.innerHTML += `<div class="text-green-600 font-bold">완료: 총 ${totalItems}건 등록됨</div>`;
                    alert(`${totalItems}건의 재고가 성공적으로 등록되었습니다.`);
                    
                    setTimeout(() => {
                         document.getElementById('upload-text').innerText = "엑셀 파일을 이곳에 드래그하거나 클릭하세요";
                         document.getElementById('upload-icon').className = "fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3";
                         document.getElementById('excel-input').value = "";
                         switchTab('inventory');
                    }, 1000);

                } catch (err) {
                    console.error(err);
                    logEl.innerHTML += `<div class="text-red-500">오류: ${err.message}</div>`;
                    alert("파일 처리 중 오류가 발생했습니다.");
                    document.getElementById('upload-text').innerText = "엑셀 파일을 이곳에 드래그하거나 클릭하세요";
                    document.getElementById('upload-icon').className = "fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        window.onload = function() {
            initFirebase();
            switchTab('dashboard');
            renderMasterTable();
        }
    </script>
</body>
</html>