<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daewoong S&T Inventory System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SheetJS (Excel Processing) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Google Font (Noto Sans KR) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { bg: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-2xl z-20">
        <div class="p-6 border-b border-slate-800 bg-slate-950">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-industry text-blue-500 text-2xl"></i>
                <div>
                    <h1 class="font-bold text-lg tracking-tight">Daewoong S&T</h1>
                    <p class="text-xs text-slate-400">Inventory Management</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchTab('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-dashboard">
                <i class="fa-solid fa-chart-pie w-5"></i> <span class="font-medium">대시보드</span>
            </button>
            <button onclick="switchTab('inventory')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-inventory">
                <i class="fa-solid fa-layer-group w-5"></i> <span class="font-medium">통합 재고 현황</span>
            </button>
            <button onclick="switchTab('upload')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all" id="nav-upload">
                <i class="fa-solid fa-file-excel w-5"></i> <span class="font-medium">엑셀 일괄 등록</span>
            </button>
        </nav>

        <div class="p-4 bg-slate-900 border-t border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold">허</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-bold truncate">허창수 법인장</p>
                    <p class="text-xs text-slate-400 truncate">admin@daewoongvina.com</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Header -->
        <header class="bg-white h-16 border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-slate-600"><i class="fa-solid fa-bars text-xl"></i></button>
                <h2 class="text-xl font-bold text-slate-800" id="page-title">대시보드</h2>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs font-semibold bg-blue-50 text-blue-700 px-3 py-1 rounded-full border border-blue-100">
                    <i class="fa-solid fa-location-dot mr-1"></i> 호치민 법인
                </span>
                <button class="text-slate-400 hover:text-slate-600 transition-colors"><i class="fa-solid fa-gear"></i></button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 overflow-auto p-6 relative">
            
            <!-- 1. Dashboard Section -->
            <div id="view-dashboard" class="space-y-6 fade-in">
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-weight-hanging text-6xl text-blue-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">총 재고 중량</p>
                        <h3 class="text-2xl font-bold text-slate-800" id="dash-total-weight">0 <span class="text-sm font-normal text-slate-500">Ton</span></h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-boxes-stacked text-6xl text-emerald-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">총 재고 수량</p>
                        <h3 class="text-2xl font-bold text-slate-800" id="dash-total-count">0 <span class="text-sm font-normal text-slate-500">EA</span></h3>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group">
                         <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-building text-6xl text-indigo-600"></i>
                        </div>
                        <p class="text-sm text-slate-500 font-medium mb-1">주요 거래처</p>
                        <h3 class="text-2xl font-bold text-slate-800">5 <span class="text-sm font-normal text-slate-500">개사</span></h3>
                    </div>
                </div>

                <!-- Vendor Breakdown -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">업체별 재고 현황</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 uppercase font-semibold">
                                <tr>
                                    <th class="px-6 py-3">업체명 (Vendor)</th>
                                    <th class="px-6 py-3 text-right">보유 수량</th>
                                    <th class="px-6 py-3 text-right">총 중량 (kg)</th>
                                    <th class="px-6 py-3">비고</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="dashboard-vendor-table">
                                <!-- JS will populate this -->
                                <tr><td colspan="4" class="p-4 text-center text-slate-400">데이터 로딩중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. Inventory List Section -->
            <div id="view-inventory" class="hidden h-full flex flex-col fade-in">
                <!-- Filters -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4 flex flex-col md:flex-row gap-4 justify-between items-center">
                    <div class="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0" id="vendor-tabs">
                        <button onclick="filterVendor('ALL')" class="vendor-tab active px-4 py-2 rounded-lg text-sm font-bold transition-colors bg-blue-600 text-white shadow-md shadow-blue-200" data-vendor="ALL">ALL</button>
                        <button onclick="filterVendor('INZI')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="INZI">INZI</button>
                        <button onclick="filterVendor('SHINHEUNG')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="SHINHEUNG">SHINHEUNG</button>
                        <button onclick="filterVendor('DAEYEONG')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="DAEYEONG">DAEYEONG</button>
                        <button onclick="filterVendor('DA')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="DA">DA</button>
                        <button onclick="filterVendor('ETD')" class="vendor-tab px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors" data-vendor="ETD">ETD</button>
                    </div>
                    <div class="relative w-full md:w-64">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="search-input" onkeyup="renderTable()" placeholder="Spec, 제품명 검색..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-sm text-left relative">
                            <thead class="bg-slate-50 text-slate-600 font-semibold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-6 py-3 whitespace-nowrap">Vendor</th>
                                    <th class="px-6 py-3 whitespace-nowrap">품명 (Product)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">Spec</th>
                                    <th class="px-6 py-3 whitespace-nowrap">두께 (T)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">폭 (W)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">길이 (L)</th>
                                    <th class="px-6 py-3 text-right whitespace-nowrap">중량 (kg)</th>
                                    <th class="px-6 py-3 whitespace-nowrap">위치</th>
                                    <th class="px-6 py-3 text-center whitespace-nowrap">관리</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="inventory-table-body">
                                <!-- Data goes here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-200 bg-slate-50 text-right text-xs text-slate-500">
                        총 검색된 항목: <span id="table-count" class="font-bold text-slate-700">0</span> 건
                    </div>
                </div>
            </div>

            <!-- 3. Upload Section -->
            <div id="view-upload" class="hidden fade-in max-w-3xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200 bg-slate-50">
                        <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-file-import text-blue-600"></i> 엑셀 재고 등록
                        </h3>
                        <p class="text-sm text-slate-500 mt-2">
                            지정된 양식의 엑셀 파일을 업로드하면 <strong>자동으로 업체를 분류</strong>하여 시스템에 등록합니다.
                        </p>
                    </div>
                    
                    <div class="p-8 space-y-8">
                        <!-- Step 1: Template -->
                        <div class="flex items-start gap-4">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold flex-shrink-0">1</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-slate-700">기본 양식 다운로드</h4>
                                <p class="text-sm text-slate-500 mb-3">아래 버튼을 눌러 기본 엑셀 양식을 다운로드하세요. 이 양식을 준수해야 정확하게 업로드됩니다.</p>
                                <button onclick="downloadTemplate()" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 text-slate-700 text-sm font-medium flex items-center gap-2 transition-colors">
                                    <i class="fa-solid fa-download"></i> 엑셀 템플릿 받기 (.xlsx)
                                </button>
                            </div>
                        </div>

                        <hr class="border-slate-100">

                        <!-- Step 2: Upload -->
                        <div class="flex items-start gap-4">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold flex-shrink-0">2</div>
                            <div class="flex-1 w-full">
                                <h4 class="font-bold text-slate-700 mb-2">파일 업로드 및 자동 분류</h4>
                                <div class="w-full border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer relative" id="drop-zone">
                                    <input type="file" id="excel-input" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3" id="upload-icon"></i>
                                    <p class="font-medium text-slate-600" id="upload-text">엑셀 파일을 이곳에 드래그하거나 클릭하세요</p>
                                    <p class="text-xs text-slate-400 mt-1">.xlsx 또는 .xls 파일만 가능</p>
                                </div>
                            </div>
                        </div>

                        <!-- Preview & Logic Description -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm">
                            <h5 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-robot"></i> 자동 업체 분류 로직 (가상)</h5>
                            <ul class="list-disc list-inside text-blue-700 space-y-1 text-xs">
                                <li><strong>INZI:</strong> 품명에 'SPHC' 포함 또는 두께 >= 2.0mm</li>
                                <li><strong>SHINHEUNG:</strong> 품명에 'GI' 포함</li>
                                <li><strong>DAEYEONG:</strong> 품명에 'CR' 포함</li>
                                <li><strong>DA:</strong> 품명에 'PO' 포함</li>
                                <li><strong>ETD:</strong> 위 조건에 해당하지 않는 나머지</li>
                            </ul>
                            <p class="mt-2 text-xs text-blue-500">* 엑셀 파일 내 'Vendor' 컬럼에 값이 있으면 해당 값이 우선 적용됩니다.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        window.db = null;
        window.auth = null;
        window.appId = 'daewoong-st-inventory-v1'; // Default App ID
        window.userId = null;
        window.inventoryData = [];
        let unsubscribe = null;

        // --- 1. Firebase Configuration (Github Deployment Ready) ---
        // [중요] 아래 firebaseConfig 객체의 값을 본인의 Firebase 프로젝트 설정값으로 변경해주세요.
        // 위치: Firebase Console -> 프로젝트 설정 -> 일반 -> 내 앱 -> SDK 설정 및 구성
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        async function initFirebase() {
            try {
                // Check if config is filled (simple validation)
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Firebase Config가 설정되지 않았습니다.");
                    // Optional: Show UI warning or run in offline/demo mode
                    // For now, let's just alert the user to check console
                    // return;
                }

                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                
                // Auth Flow: Anonymous Sign-In
                await signInAnonymously(window.auth);

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Logged in:", user.uid);
                        loadInventory(); // Start listening to data
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                // Fallback for demo visualization without DB
                document.getElementById('inventory-table-body').innerHTML = '<tr><td colspan="9" class="p-8 text-center text-red-500">데이터베이스 연결 실패<br><span class="text-xs text-slate-400">index.html 파일을 열어 firebaseConfig 값을 설정해주세요.</span></td></tr>';
            }
        }

        // --- 2. Data Loading & Listener ---
        function loadInventory() {
            if (!window.db || !window.userId) return;

            const q = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory');
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                window.inventoryData = [];
                snapshot.forEach((doc) => {
                    window.inventoryData.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort locally by entry date descending
                window.inventoryData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                updateDashboard();
                renderTable(); // Initial render
            }, (error) => {
                console.error("Data fetch error:", error);
            });
        }

        // --- 3. UI Functions ---
        window.switchTab = function(tabName) {
            // Update Tab Content Visibility
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-inventory').classList.add('hidden');
            document.getElementById('view-upload').classList.add('hidden');
            
            document.getElementById(`view-${tabName}`).classList.remove('hidden');

            // Update Page Title
            const titles = {
                'dashboard': '대시보드',
                'inventory': '통합 재고 현황',
                'upload': '엑셀 일괄 등록'
            };
            document.getElementById('page-title').innerText = titles[tabName];

            // Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                el.classList.add('text-slate-400');
            });
            const activeNav = document.getElementById(`nav-${tabName}`);
            activeNav.classList.remove('text-slate-400');
            activeNav.classList.add('bg-blue-600', 'text-white', 'shadow-lg');

            if(tabName === 'inventory') renderTable();
        }

        window.currentVendorFilter = 'ALL';

        window.filterVendor = function(vendor) {
            window.currentVendorFilter = vendor;
            
            // UI Update for tabs
            document.querySelectorAll('.vendor-tab').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'active');
                btn.classList.add('text-slate-600', 'hover:bg-slate-100');
                if(btn.dataset.vendor === vendor) {
                    btn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'active');
                }
            });

            renderTable();
        }

        window.renderTable = function() {
            const tbody = document.getElementById('inventory-table-body');
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = window.inventoryData.filter(item => {
                // Vendor Filter
                if (window.currentVendorFilter !== 'ALL' && item.vendor !== window.currentVendorFilter) return false;
                
                // Search Filter
                const searchStr = `${item.product} ${item.spec} ${item.location}`.toLowerCase();
                if (searchInput && !searchStr.includes(searchInput)) return false;
                
                return true;
            });

            document.getElementById('table-count').innerText = filtered.length;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-slate-400">데이터가 없습니다.</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(item => `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50">
                    <td class="px-6 py-3 font-bold text-xs">
                        <span class="px-2 py-1 rounded bg-slate-100 text-slate-600 border border-slate-200">${item.vendor}</span>
                    </td>
                    <td class="px-6 py-3 font-medium text-slate-800">${item.product || '-'}</td>
                    <td class="px-6 py-3 text-slate-600">${item.spec || '-'}</td>
                    <td class="px-6 py-3 text-slate-600">${item.thickness || 0}</td>
                    <td class="px-6 py-3 text-slate-600">${item.width || 0}</td>
                    <td class="px-6 py-3 text-slate-600">${item.length || 0}</td>
                    <td class="px-6 py-3 text-right font-mono font-bold text-slate-700">${Number(item.weight).toLocaleString()}</td>
                    <td class="px-6 py-3 text-center text-xs text-slate-500 bg-slate-50 rounded mx-2">${item.location || '미지정'}</td>
                    <td class="px-6 py-3 text-center">
                        <button onclick="deleteItem('${item.id}')" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        window.deleteItem = async function(id) {
            if(confirm('정말 삭제하시겠습니까?')) {
                try {
                    await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory', id));
                    // Listener will update UI
                } catch(e) {
                    alert('삭제 중 오류 발생: ' + e.message);
                }
            }
        }

        function updateDashboard() {
            // Calculate Totals
            const totalW = window.inventoryData.reduce((acc, curr) => acc + (Number(curr.weight) || 0), 0);
            const totalC = window.inventoryData.length;

            document.getElementById('dash-total-weight').innerHTML = `${(totalW/1000).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})} <span class="text-sm font-normal text-slate-500">Ton</span>`;
            document.getElementById('dash-total-count').innerHTML = `${totalC.toLocaleString()} <span class="text-sm font-normal text-slate-500">EA</span>`;

            // Calculate Vendor Stats
            const vendors = ['INZI', 'SHINHEUNG', 'DAEYEONG', 'DA', 'ETD'];
            const stats = {};
            vendors.forEach(v => stats[v] = { count: 0, weight: 0 });
            
            window.inventoryData.forEach(item => {
                const v = item.vendor && vendors.includes(item.vendor) ? item.vendor : 'ETD';
                if (!stats[v]) stats[v] = { count: 0, weight: 0 }; // Safety
                stats[v].count++;
                stats[v].weight += (Number(item.weight) || 0);
            });

            // Update Vendor Table
            const vendorTableHTML = vendors.map(v => `
                <tr class="hover:bg-slate-50 border-b border-slate-50">
                    <td class="px-6 py-4 font-bold text-slate-700">${v}</td>
                    <td class="px-6 py-4 text-right">${stats[v].count.toLocaleString()} EA</td>
                    <td class="px-6 py-4 text-right font-mono">${stats[v].weight.toLocaleString()} kg</td>
                    <td class="px-6 py-4">
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${totalW > 0 ? (stats[v].weight / totalW * 100) : 0}%"></div>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('dashboard-vendor-table').innerHTML = vendorTableHTML;
        }

        // --- 4. Excel & Logic Functions ---

        // Auto Classification Logic
        function determineVendor(row) {
            // 1. Explicit Vendor in Excel?
            if (row.vendor && ['INZI', 'SHINHEUNG', 'DAEYEONG', 'DA', 'ETD'].includes(row.vendor.toUpperCase())) {
                return row.vendor.toUpperCase();
            }

            const product = (row.product || '').toUpperCase();
            const spec = (row.spec || '').toUpperCase();
            const thickness = Number(row.thickness) || 0;
            const width = Number(row.width) || 0;

            // 2. Logic Rules (Example - Based on prompt "Check Name, Thickness, Width, Length")
            // Rule 1: INZI (Example: SPHC or Thick >= 2.0)
            if (product.includes('SPHC') || thickness >= 2.0) {
                return 'INZI';
            }
            // Rule 2: SHINHEUNG (Example: GI)
            if (product.includes('GI') || spec.includes('GI')) {
                return 'SHINHEUNG';
            }
            // Rule 3: DAEYEONG (Example: CR)
            if (product.includes('CR') || spec.includes('CR')) {
                return 'DAEYEONG';
            }
            // Rule 4: DA (Example: PO)
            if (product.includes('PO') || spec.includes('PO')) {
                return 'DA';
            }
            
            // Rule 5: Default to ETD
            return 'ETD';
        }

        window.downloadTemplate = function() {
            const wb = XLSX.utils.book_new();
            const headers = [
                ['Vendor', 'Product', 'Spec', 'Thickness', 'Width', 'Length', 'Weight', 'Location']
            ];
            // Sample Data
            const sampleData = [
                ['', 'Coil (SPHC)', 'SPHC', 2.3, 1219, 0, 15000, 'A-01'],
                ['', 'Sheet (GI)', 'GI', 0.8, 1000, 2438, 2500, 'B-02'],
                ['DA', 'Coil (PO)', 'PO', 1.6, 1219, 0, 12000, 'C-05']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet([...headers, ...sampleData]);
            
            // Col widths
            ws['!cols'] = [
                {wch: 10}, {wch: 20}, {wch: 15}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 15}, {wch: 10}
            ];

            XLSX.utils.book_append_sheet(wb, ws, "Inventory_Template");
            XLSX.writeFile(wb, "Daewoong_Inventory_Template.xlsx");
        }

        window.handleFileSelect = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Update UI
            document.getElementById('upload-text').innerText = `처리중: ${file.name}`;
            document.getElementById('upload-icon').className = "fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-3";

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Assume first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        alert("엑셀 파일에 데이터가 없습니다.");
                        resetUploadUI();
                        return;
                    }

                    // Process Data
                    const batchSize = 500; 
                    let batch = writeBatch(window.db);
                    let count = 0;
                    
                    // Map Excel Headers to DB Fields & Apply Logic
                    jsonData.forEach((row, index) => {
                        // Normalize keys (remove spaces, lowercase) for safer matching if headers vary slightly
                        // Here we assume user follows template keys: Vendor, Product, Spec, Thickness, Width, Length, Weight, Location
                        
                        const item = {
                            product: row['Product'] || row['품명'] || '',
                            spec: row['Spec'] || row['규격'] || '',
                            thickness: row['Thickness'] || row['두께'] || 0,
                            width: row['Width'] || row['폭'] || 0,
                            length: row['Length'] || row['길이'] || 0,
                            weight: row['Weight'] || row['중량'] || 0,
                            location: row['Location'] || row['위치'] || '',
                            vendorInExcel: row['Vendor'] || row['업체'] || '', // Explicit vendor
                            createdAt: new Date().toISOString()
                        };

                        // Logic
                        item.vendor = determineVendor(item);

                        // Add to Firestore Batch
                        const docRef = doc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'inventory'));
                        batch.set(docRef, item);
                        count++;

                        // Commit every 500 items (Firestore limit)
                        if (count % batchSize === 0) {
                            // In a real app we would await batch.commit() and start a new one.
                            // For simplicity in this demo, we assume < 500 items or simple batch.
                        }
                    });

                    await batch.commit();
                    
                    alert(`${count}건의 재고가 성공적으로 등록되었습니다.`);
                    switchTab('inventory'); // Go to list view
                } catch (err) {
                    console.error(err);
                    alert("파일 처리 중 오류가 발생했습니다: " + err.message);
                } finally {
                    resetUploadUI();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function resetUploadUI() {
            document.getElementById('upload-text').innerText = "엑셀 파일을 이곳에 드래그하거나 클릭하세요";
            document.getElementById('upload-icon').className = "fa-solid fa-cloud-arrow-up text-4xl text-slate-300 mb-3";
            document.getElementById('excel-input').value = ""; // Reset input
        }

        // Initialize App
        window.onload = function() {
            initFirebase();
            switchTab('dashboard'); // Default Tab
        }
    </script>
</body>
</html>